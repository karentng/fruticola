{% extends "base.html.twig" %}

{% block html_head %}
<style type="text/css">
    #map-canvas{
        width: 1100px;
        height: 500px;
    }
</style>
<script type="text/javascript">
    $(function() {
        {% if notif %}
            notif({{notif|json_encode}});
        {% endif %}

        $("input[type=number]").keydown(function(event) {
            // Allow: backspace, delete, tab, escape, enter and .
            if ( $.inArray(event.keyCode,[46,8,9,27,13,190]) !== -1 ||
                 // Allow: Ctrl+A
                (event.keyCode == 65 && event.ctrlKey === true) || 
                 // Allow: home, end, left, right
                (event.keyCode >= 35 && event.keyCode <= 39)) {
                     // let it happen, don't do anything
                     return;
            }
            else {
                // Ensure that it is a number and stop the keypress
                if (event.shiftKey || (event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105 )) {
                    event.preventDefault(); 
                }   
            }
        });
    });
</script>


<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>

<script>
    var marks = [];
    var infos = [];
    var municipios = {{municipiosJSON}};
    var productores = {{productoresJSON}};
    var renglon = {{renglonJSON}};

    function initialize() {
        var fincas = {{fincas}};

        var mapOptions = {
            zoom: 7,
            center: new google.maps.LatLng(3.4205556, -76.5222221999999)
        };

        var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
        

        for(var i=0;i<fincas.length;i++){
            var position1 = new google.maps.LatLng(fincas[i].geo_latitud,fincas[i].geo_longitud);
            var marker1 = new google.maps.Marker({ position: position1, map: map});
            marker1.setTitle(fincas[i].nombre);
            marks.push(marker1);
            var contentString1 = '<div style="width:200px" align="center"><h3><b>'+fincas[i].nombre+'</b></h3>'+
                                    '<br/>';
            if(productores[i] != ""){
                contentString1 += "<b>Productor: </b>"+productores[i]+"<br/>";
            }
            if(fincas[i].vereda != ""){
                contentString1 += "<b>Vereda: </b>"+fincas[i].vereda+"<br/>";
            }
            if(fincas[i].sector != ""){
                contentString1 += "<b>Sector: </b>"+fincas[i].sector+"<br/>";
            }
            if(fincas[i].area_total != ""){
                contentString1 += "<b>Área Total: </b>"+fincas[i].area_total+"<br/>";
            }
            if(renglon[i] != ""){
                contentString1 += "<b>Renglón: </b>"+renglon[i]+"<br/>";   
            }
            
            contentString1 += '</div>';

            var infowindow1 = new google.maps.InfoWindow({ 
                content: contentString1,
                maxWidth: 220
            })

            infos.push(infowindow1);

            google.maps.event.addListener(marker1, 'click', function() {
                var pos = marks.indexOf(this);
                infos[pos].open(this.get('map'), this);
            });
        }
    }
    function eliminar(){
        for (var i = 0; i < marks.length; i++ ) {
            marks[i].setMap(null);
        }
        for (var i = 0; i < infos.length; i++ ) {
            infos[i].setMap(null);
        }
        infos.length = 0;
        marks.length = 0;
    }
    function agregar(){
        eliminar();
        var idPredio = $("#predio").val();
        
        var fincas;

        $.ajax({
            async:false, 
            cache:false, 
            type: 'POST',   
            url: "{{base_url('reportes/ubicaciongoogle/fincasPorMunicipio')}}",
            data: {id: idPredio}, 
            success:  function(data){
                console.log($.parseJSON(data));
                data = $.parseJSON(data);
                fincas = data[0];
                productores = data[1];
                renglon = data[2];
            }
        });

        var mapOptions = {
            zoom: 7,
            center: new google.maps.LatLng(municipios[idPredio-1].latitud, municipios[idPredio-1].longitud)
        };

        var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
        

        for(var i=0;i<fincas.length;i++){
            var position1 = new google.maps.LatLng(fincas[i].geo_latitud,fincas[i].geo_longitud);
            var marker1 = new google.maps.Marker({ position: position1, map: map});
            marker1.setTitle(fincas[i].nombre);
            marks.push(marker1);
            var contentString1 = '<div style="width:200px" align="center"><h3><b>'+fincas[i].nombre+'</b></h3>'+
                                    '<br/>';
            if(productores[i] != ""){
                contentString1 += "<b>Productor: </b>"+productores[i]+"<br/>";
            }
            if(fincas[i].vereda != ""){
                contentString1 += "<b>Vereda: </b>"+fincas[i].vereda+"<br/>";
            }
            if(fincas[i].sector != ""){
                contentString1 += "<b>Sector: </b>"+fincas[i].sector+"<br/>";
            }
            if(fincas[i].area_total != ""){
                contentString1 += "<b>Área Total: </b>"+fincas[i].area_total+"<br/>";
            }
            if(renglon[i] != ""){
                contentString1 += "<b>Renglón: </b>"+renglon[i]+"<br/>";   
            }

            var infowindow1 = new google.maps.InfoWindow({ 
                content: contentString1,
                maxWidth: 220
            })

            infos.push(infowindow1);

            google.maps.event.addListener(marker1, 'click', function() {
                var pos = marks.indexOf(this);
                infos[pos].open(this.get('map'), this);
            });
        }

    }
    google.maps.event.addDomListener(window, 'load', initialize);

</script>

{% endblock %}
{% block breadcrumnb %}
    <ul class="breadcrumb">
      <li><a href="{{site_url('listadoruats')}}"><i class="icon16 i-home-4"></i>Inicio</a></li>
      <li><strong class="text-success">UBICACIÓN DE PREDIOS</strong></li>
    </ul>
{% endblock %}

{% block titulo %}
    <h1><i class="icon20 i-stack-checkmark"></i> UBICACIÓN DE PREDIOS </h1> 
{% endblock %}

{% block contenido %}

{% include "reportes/toolbar_reportes.html.twig" %}
Seleccione el Municipio del cual quiere ver los predios:
<br />

<select id="predio" style="margin-bottom:5px;" onchange="agregar()">
    {% for m in municipios %}
        <option value="{{m.id}}">{{m.nombre}}</option>
    {% endfor %}
</select>
<div id="map-canvas"></div>
{% endblock %}